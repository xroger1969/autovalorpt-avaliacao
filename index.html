<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AutoValorPT — Pedido de Avaliação</title>
  <!-- estilos mantêm-se como no ficheiro actual -->
  <style>
    /* … mesmo CSS da versão simplificada … */
  </style>
</head>
<body>
  <h1>AutoValorPT — Pedido de Avaliação</h1>
  <p class="sub">Preenche os dados e anexa fotos da viatura. Receberás resposta assim que possível.</p>

  <form id="form">
    <!-- dados pessoais -->
    <div class="row">
      <div>
        <label>Nome *</label>
        <input name="nome" required />
      </div>
      <div>
        <label>E‑mail *</label>
        <input name="email" type="email" required />
      </div>
    </div>
    <label>Contacto *</label>
    <input name="contacto" type="tel" placeholder="+351 ..." required />

    <!-- dados da viatura -->
    <label>Marca *</label>
    <input name="marca" required />
    <label>Modelo *</label>
    <input name="modelo" required />
    <div class="row">
      <div>
        <label>Ano *</label>
        <input name="ano" type="number" min="1900" max="2099" step="1" required />
      </div>
      <div>
        <label>Quilómetros *</label>
        <input name="km" type="number" min="0" required />
      </div>
    </div>
    <label>Combustível *</label>
    <input name="combustivel" placeholder="Gasolina, Gasóleo, Eléctrico…" required />
    <label>Caixa de velocidades *</label>
    <input name="caixa" placeholder="Manual, Automática…" required />
    <label>Versão</label>
    <input name="versao" />
    <label>Matrícula</label>
    <input name="matricula" />

    <!-- outras informações -->
    <label>Observações</label>
    <textarea name="observacoes" placeholder="Ex.: extras, estado geral…"></textarea>

    <label>Fotos da viatura *</label>
    <input id="fotos" type="file" accept="image/*" multiple required />
    <div class="hint">Máximo 12 fotos. Sugestão: frente, trás, laterais, interior, painel e motor.</div>

    <button id="btn" type="submit">Enviar pedido</button>
    <p class="small">Ao enviar, aceitas que os dados sejam usados apenas para análise da avaliação AutoValorPT.</p>
  </form>

  <div id="status" class="status"></div>

<script>
// mesmas constantes que já existiam
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyJukiTX7W7Wz-QdU651LkSoqWSfHko6c1rTY6tppIDjBLkEWXU1dE4QlCjPq6kPac-/exec";
const NOTIFICATION_EMAIL = "c.vasconcelos1969@gmail.com";
const MAX_PHOTOS = 12;
const MAX_TOTAL_MB = 40;
const MAX_DIM = 1600;
const JPEG_QUALITY = 0.8;

const form = document.getElementById("form");
const fotosInput = document.getElementById("fotos");
const statusBox = document.getElementById("status");
const btn = document.getElementById("btn");

// funções auxiliares iguais às anteriores: setStatus, bytesToMB, compressImageToBase64 …

form.addEventListener("submit", async (event) => {
  event.preventDefault();
  statusBox.style.display = "none";

  const fotos = Array.from(fotosInput.files || []);
  if (!fotos.length) return setStatus("Por favor, seleciona pelo menos 1 foto.", "err");
  if (fotos.length > MAX_PHOTOS) return setStatus(`Selecionaste ${fotos.length} fotos. Máximo permitido: ${MAX_PHOTOS}.`, "err");

  btn.disabled = true;
  btn.textContent = "A enviar...";

  try {
    setStatus("A enviar dados do pedido...");

    const fd = new FormData(form);
    const payloadInit = new URLSearchParams();
    payloadInit.set("action", "init");
    // inclui também os campos da viatura no payload
    ["nome","email","contacto","observacoes","marca","modelo","ano","km","combustivel","caixa","versao","matricula"].forEach((key) => {
      payloadInit.set(key, (fd.get(key) || "").toString().trim());
    });
    payloadInit.set("totalFotos", String(fotos.length));
    payloadInit.set("notificationEmail", NOTIFICATION_EMAIL);

    const initResponse = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: payloadInit.toString()
    });

    const init = await initResponse.json();
    if (!init.ok) throw new Error(init.error || "Não foi possível iniciar o pedido.");

    // ciclo de upload de fotos igual ao ficheiro actual …

    setStatus("Pedido enviado com sucesso ✅ Obrigado! Vamos entrar em contacto.");
    form.reset();
  } catch (error) {
    setStatus("Erro: " + String(error.message || error), "err");
  } finally {
    btn.disabled = false;
    btn.textContent = "Enviar pedido";
  }
});
</script>
</body>
</html>

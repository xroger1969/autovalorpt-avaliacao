<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AutoValorPT — Pedido de Avaliação</title>
  <style>
    :root{
      --bg-dark:#0b3a6d;
      --bg-mid:#145aa6;
      --bg-light:#1f78d1;
      --card:#0f3f7acc;
      --border:#8ab2e6;
      --text:#eef6ff;
      --muted:#b9cae6;
      --input-bg:#11407a;
      --accent:#e0ecff;
    }
    body{
      font-family:Arial, sans-serif;
      max-width:820px;
      margin:24px auto;
      padding:0 12px;
      color:var(--text);
      background: radial-gradient(circle at 18% 18%, #2b82da 0%, transparent 35%), linear-gradient(155deg, var(--bg-light) 0%, var(--bg-mid) 45%, var(--bg-dark) 100%);
      min-height:100vh;
    }
    h1{margin:0 0 6px; color:#ffffff; text-shadow:0 2px 10px rgba(0,0,0,.55);}
    h3{color:#f3f7ff;}
    .sub{margin:0 0 18px; color:var(--muted);}
    form{
      background:var(--card);
      border:1px solid rgba(207,217,232,.35);
      box-shadow:0 10px 35px rgba(0,0,0,.35);
      border-radius:14px;
      padding:20px;
      backdrop-filter:blur(1px);
    }
    label{display:block; margin-top:14px; font-weight:700;}
    input, select, textarea, button{
      width:100%;
      padding:10px;
      margin-top:6px;
      box-sizing:border-box;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--input-bg);
      color:var(--text);
    }
    input::placeholder, textarea::placeholder{color:#9fb6d8;}
    textarea{min-height:120px;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;}
    .hint{font-size:.9rem; color:#b2c3df; margin-top:6px;}
    .status{margin-top:14px; padding:10px; border:1px solid #ddd; border-radius:10px; display:none; white-space:pre-line;}
    .ok{border-color:#78d7c9; background:#11483f; color:#d4fff6;}
    .err{border-color:#f3a8a8; background:#5a1e27; color:#ffe4e4;}
    button{
      margin-top:18px;
      cursor:pointer;
      background:linear-gradient(180deg, #f2f6ff 0%, var(--accent) 100%);
      color:#0c2c56;
      font-weight:700;
      text-shadow:0 1px 0 rgba(255,255,255,.4);
      border:1px solid #e9f2ff;
    }
    button:disabled{opacity:.75; cursor:progress;}
    .small{font-size:.9rem; color:#b9cae6;}
  </style>
</head>
<body>
  <h1>AutoValorPT — Pedido de Avaliação</h1>
  <p class="sub">Preenche os dados e anexa fotos da viatura. Assim que possível entramos em contacto.</p>
  <form id="form" action="https://formsubmit.co/el/digejo" method="POST" enctype="multipart/form-data">
    <div class="row">
      <div>
        <label>Nome *</label>
        <input name="nome" required />
      </div>
      <div>
        <label>E-mail *</label>
        <input name="email" type="email" required />
      </div>
    </div>
    <label>Contacto *</label>
    <input name="contacto" type="tel" placeholder="+351 ..." required />
    <h3 style="margin-top:22px;">Dados da viatura</h3>
    <div class="row">
      <div>
        <label>Marca</label>
        <input name="marca" placeholder="Ex.: BMW" />
      </div>
      <div>
        <label>Modelo</label>
        <input name="modelo" placeholder="Ex.: Série 3" />
      </div>
    </div>
    <div class="row3">
      <div>
        <label>Ano</label>
        <input name="ano" inputmode="numeric" placeholder="Ex.: 2017" />
      </div>
      <div>
        <label>Quilometragem (km)</label>
        <input name="km" inputmode="numeric" placeholder="Ex.: 120000" />
      </div>
      <div>
        <label>Combustível</label>
        <select name="combustivel">
          <option value="">—</option>
          <option>Gasolina</option>
          <option>Gasóleo</option>
          <option>Híbrido</option>
          <option>Híbrido Plug-in</option>
          <option>Elétrico</option>
          <option>GPL</option>
          <option>Outro</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Caixa</label>
        <select name="caixa">
          <option value="">—</option>
          <option>Manual</option>
          <option>Automática</option>
          <option>Outra</option>
        </select>
      </div>
      <div>
        <label>Versão</label>
        <input name="versao" placeholder="Ex.: Pack M / AMG Line / Tekna..." />
      </div>
    </div>
    <label>Matrícula (opcional)</label>
    <input name="matricula" placeholder="Ex.: 12-AB-34" />
    <label>Observações</label>
    <textarea name="observacoes" placeholder="Estado geral, histórico, extras, se tem acidentes, revisões, pneus, motor, documentos relevantes."></textarea>
    <label>Fotos da viatura *</label>
    <input id="fotos" name="upload" type="file" accept="image/*" multiple required />
    <div class="hint">Máximo 12 fotos. Sugestão: frente, trás, laterais, interior, painel, quilómetros, pneus, motor, documentos relevantes.</div>
    <input type="hidden" name="_subject" value="AutoValorPT — Novo pedido de avaliação" />
    <input type="hidden" name="_template" value="table" />
    <input type="hidden" name="_captcha" value="false" />
    <input type="hidden" name="_autoresponse" value="Recebemos o teu pedido de avaliação na AutoValorPT. Em breve entraremos em contacto. Obrigado!" />
    <input type="text" name="_honey" style="display:none" />
    <input type="hidden" name="_next" value="https://TEU_UTILIZADOR.github.io/TEU_REPO/obrigado.html" />
    <button id="btn" type="submit">Enviar pedido</button>
    <p class="small">Ao enviar, aceitas que os dados sejam usados apenas para análise da avaliação AutoValorPT.</p>
    <p class="small"><a href="https://formsubmit.co/el/digejo" target="_blank" rel="noopener noreferrer">Email us</a></p>
  </form>
  <div id="status" class="status"></div>
  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyJukiTX7W7Wz-QdU651LkSoqWSfHko6c1rTY6tppIDjBLkEWXU1dE4QlCjPq6kPac-/exec";
    const FORMSUBMIT_URL = "https://formsubmit.co/el/digejo";
    const MAX_PHOTOS = 12;
    const MAX_TOTAL_MB = 40;
    const MAX_DIM = 1600;
    const JPEG_QUALITY = 0.80;
    const form = document.getElementById("form");
    const fotosInput = document.getElementById("fotos");
    const statusBox = document.getElementById("status");
    const btn = document.getElementById("btn");

    function setStatus(msg, type="ok") {
      statusBox.className = "status " + (type === "err" ? "err" : "ok");
      statusBox.style.display = "block";
      statusBox.textContent = msg;
    }

    function bytesToMB(b){ return b / (1024 * 1024); }

    async function sendFormsubmitNotification(formData, totalFotos) {
      try {
        const payload = new FormData();
        formData.forEach((value, key) => payload.append(key, value));
        const email = formData.get("email");
        if (email) payload.set("_replyto", email.toString().trim());
        if (typeof totalFotos === "number") payload.set("totalFotos", String(totalFotos));
        const response = await fetch(FORMSUBMIT_URL, {
          method: "POST",
          body: payload
        });
        if (!response.ok) {
          console.warn("FormSubmit respondeu com erro:", response.status);
        }
      } catch (err) {
        console.warn("Falha ao enviar notificação via FormSubmit:", err);
      }
    }

    async function compressImageToBase64(file) {
      const dataUrl = await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = dataUrl;
      });
      let w = img.width, h = img.height;
      const maxSide = Math.max(w, h);
      if (maxSide > MAX_DIM) {
        const scale = MAX_DIM / maxSide;
        w = Math.round(w * scale);
        h = Math.round(h * scale);
      }
      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      const outDataUrl = canvas.toDataURL("image/jpeg", JPEG_QUALITY);
      const base64 = outDataUrl.split(",")[1];
      return { base64, mimeType: "image/jpeg" };
    }

    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      statusBox.style.display = "none";
      const notificationData = new FormData(form);
      const fotos = Array.from(fotosInput.files || []);
      if (!fotos.length) return setStatus("Por favor, seleciona pelo menos 1 foto.", "err");
      if (fotos.length > MAX_PHOTOS) return setStatus(`Selecionaste ${fotos.length} fotos. Máximo permitido: ${MAX_PHOTOS}.`, "err");
      btn.disabled = true;
      btn.textContent = "A enviar...";
      try {
        setStatus("A enviar dados do pedido...");
        const fd = new FormData(form);
        const payloadInit = new URLSearchParams();
        payloadInit.set("action", "init");
        [ "nome","email","contacto","marca","modelo","ano","km", "combustivel","caixa","versao","matricula","observacoes" ].forEach(k => payloadInit.set(k, (fd.get(k) || "").toString().trim()));
        payloadInit.set("totalFotos", String(fotos.length));
        const r1 = await fetch(WEBAPP_URL, { method: "POST", headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}, body: payloadInit.toString() });
        const init = await r1.json();
        if (!init.ok) throw new Error(init.error || "Não foi possível iniciar o pedido.");
        const { submissionId, folderId } = init;
        let totalBytes = 0;
        for (let i = 0; i < fotos.length; i++) {
          setStatus(`A preparar e enviar fotos... (${i+1}/${fotos.length})`);
          const file = fotos[i];
          const { base64, mimeType } = await compressImageToBase64(file);
          totalBytes += Math.floor(base64.length * 0.75);
          if (bytesToMB(totalBytes) > MAX_TOTAL_MB) {
            throw new Error(`O total das imagens ficou demasiado pesado (~${bytesToMB(totalBytes).toFixed(1)} MB). Envia menos fotos ou fotos mais leves.`);
          }
          const payloadUp = new URLSearchParams();
          payloadUp.set("action", "upload");
          payloadUp.set("submissionId", submissionId);
          payloadUp.set("folderId", folderId);
          payloadUp.set("filename", file.name || `foto_${i+1}.jpg`);
          payloadUp.set("mimeType", mimeType);
          payloadUp.set("fileBase64", base64);
          const r2 = await fetch(WEBAPP_URL, { method: "POST", headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}, body: payloadUp.toString() });
          const up = await r2.json();
          if (!up.ok) throw new Error(up.error || "Falha no upload de uma das fotos.");
        }
        await sendFormsubmitNotification(notificationData, fotos.length);
        setStatus("Pedido enviado com sucesso ✅ Obrigado! Vamos entrar em contacto.");
        form.reset();
      } catch (err) {
        setStatus("Erro: " + String(err.message || err), "err");
      } finally {
        btn.disabled = false;
        btn.textContent = "Enviar pedido";
      }
    });
  </script>
</body>
</html>
